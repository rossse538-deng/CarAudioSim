<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦è½½é«˜éŸ³æ³¢å¯¼è®¾è®¡ V43 & 3Dä»¿çœŸ V13.5 (ç®—æ³•å±•ç¤ºç‰ˆ)</title>
    
    <!-- Three.js ä¾èµ– (æ¥è‡ª Code B) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "three-mesh-bvh": "https://unpkg.com/three-mesh-bvh@0.7.0/build/index.module.js"
            }
        }
    </script>

    <style>
        /* ================= CODE A æ ·å¼ (åŸºç¡€ UI) ================= */
        :root {
            --bg: #1a1a1a;
            --panel: #2b2b2b;
            --accent: #3498db;
            --warn: #e74c3c;
            --text: #ecf0f1;
            --border: #444;
            --beam: #00e5ff;
        }

        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }

        /* Header - Modified z-index to fix tooltip occlusion */
        header { background: #222; padding: 10px 0; border-bottom: 1px solid #333; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; z-index: 200;}
        h1 { margin: 0; font-size: 22px; letter-spacing: 1.5px; color: #fff; font-weight: 700; }
        .algo-badge { font-size: 11px; color: #888; border: 1px solid #444; padding: 2px 12px; border-radius: 12px; margin-top: 5px; cursor: help; position: relative; }
        .algo-badge:hover { color: var(--accent); border-color: var(--accent); background: rgba(52, 152, 219, 0.1); }
        .tooltip { visibility: hidden; position: absolute; top: 120%; left: 50%; transform: translateX(-50%); width: 380px; background: #333; padding: 15px; border: 1px solid #555; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); opacity: 0; transition: 0.2s; color: #ccc; line-height: 1.5; text-align: left; z-index: 999; pointer-events: none;}
        .algo-badge:hover .tooltip { visibility: visible; opacity: 1; top: 110%; }

        /* Layout */
        .layout { display: grid; grid-template-columns: 360px 1fr; gap: 20px; padding: 20px; height: calc(100vh - 75px); box-sizing: border-box; }
        
        /* Left Controls */
        .controls { overflow-y: auto; padding-right: 8px; display: flex; flex-direction: column; gap: 15px; }
        .panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid var(--border); flex-shrink: 0; }
        .panel-h { color: var(--accent); font-size: 14px; font-weight: bold; border-bottom: 2px solid #3d3d3d; padding-bottom: 8px; margin-bottom: 12px; }
        
        .row { margin-bottom: 16px; }
        .row-head { display: flex; justify-content: space-between; font-size: 13px; color: #bbb; margin-bottom: 5px; font-weight: 600; }
        .val { color: var(--accent); font-family: monospace; font-weight: bold; }
        
        input[type=range] { width: 100%; height: 6px; background: #444; border-radius: 3px; outline: none; -webkit-appearance: none; cursor: pointer; display: block; margin: 8px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--accent); border-radius: 50%; transition: transform 0.1s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        
        .desc { font-size: 11px; color: #888; line-height: 1.4; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px; margin-top: 4px; border-left: 2px solid #555; }

        #i-simFreq::-webkit-slider-thumb { background: var(--beam); box-shadow: 0 0 8px var(--beam); }
        #i-angle::-webkit-slider-thumb { background: #f1c40f; }
        #i-twExit::-webkit-slider-thumb { background: #e74c3c; }

        /* Right Workspace */
        .workspace { display: grid; grid-template-rows: auto 1fr 180px; gap: 15px; height: 100%; overflow: hidden; }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; min-height: 80px; }
        .card { background: #252525; border-left: 3px solid #666; padding: 12px; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; }
        .card.good { border-color: #27ae60; background: rgba(39, 174, 96, 0.1); }
        .card.warn { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        .lbl { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .num { font-size: 20px; font-weight: bold; color: #fff; margin: 4px 0; }
        .sub { font-size: 11px; color: #aaa; }

        /* Viewport */
        .view-box { background: #111; border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .tabs { display: flex; background: #1f1f1f; border-bottom: 1px solid #444; flex-shrink: 0; z-index: 100; }
        .tab { flex: 1; padding: 10px; background: none; border: none; color: #888; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .tab.active { color: #fff; background: #2d2d2d; border-bottom-color: var(--accent); }

        .canvas-wrap { flex: 1; position: relative; overflow: hidden; }
        canvas#cvs2d { display: block; width: 100%; height: 100%; outline: none; cursor: crosshair; }
        
        .legend { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.85); padding: 10px; border-radius: 4px; pointer-events: none; border: 1px solid #444; backdrop-filter: blur(4px); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .l-row { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #ccc; margin-bottom: 6px; justify-content: flex-start; }
        .dot { width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .dot.l-warn { background:#e74c3c; }
        .dot.l-beam { background:var(--beam); }
        .dot.l-skin { background:#f1c40f; }
        .dot.l-part { background:#3498db; }

        /* Bottom Area */
        .bottom-area { display: flex; gap: 15px; height: 100%; overflow: visible; }
        .mats { flex: 1; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px; overflow-y: auto; }
        .m-item { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 4px; font-size: 12px; background: rgba(255,255,255,0.05); margin-bottom: 6px; }
        .m-item.rec { border: 1px solid #27ae60; background: rgba(39,174,96,0.1); }
        .m-item.bad { border: 1px solid #e74c3c; background: rgba(231,76,60,0.1); }

        .rhino-box { flex: 1.2; background: #151515; border: 1px solid #444; border-radius: 6px; padding: 12px; font-family: monospace; font-size: 11px; color: #ccc; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .rhino-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #444; padding-bottom: 5px; margin-bottom: 8px; }
        .rhino-title { color: #f1c40f; font-weight: bold; font-size: 12px; }
        .rhino-help { cursor: help; font-size: 14px; position: relative; }
        .rhino-tooltip { visibility: hidden; position: absolute; bottom: 100%; right: 0; width: 280px; background: #333; padding: 12px; border: 1px solid #666; border-radius: 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.9); color: #eee; line-height: 1.5; opacity: 0; transition: all 0.2s ease-in-out; pointer-events: none; white-space: normal; z-index: 9999; margin-bottom: 10px; }
        .rhino-tooltip::after { content: ""; position: absolute; top: 100%; right: 10px; border-width: 6px; border-style: solid; border-color: #666 transparent transparent transparent; }
        .rhino-help:hover .rhino-tooltip { visibility: visible; opacity: 1; bottom: 125%; }
        .coord-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 8px; }
        .coord-row { display: flex; justify-content: space-between; color: #999; }
        .coord-val { color: #fff; }
        .copy-btn { background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 8px; cursor: pointer; text-align: center; transition: 0.2s; width: 100%; font-weight: bold; font-size: 12px; }
        .copy-btn:hover { background: var(--accent); border-color: var(--accent); }

        /* ================= CODE B æ ·å¼ (3D ä»¿çœŸç¯å¢ƒ) ================= */
        #three-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #111; overflow: hidden;
            display: none; 
        }
        
        #b-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 36px;
            background: rgba(15, 15, 18, 0.9); border-bottom: 1px solid #333;
            display: flex; align-items: center; padding: 0 15px;
            color: #666; z-index: 10; font-size: 11px;
            justify-content: space-between; box-sizing: border-box;
        }
        .brand-group { display: flex; align-items: center; }
        .version-tag { background:#ff0000; color:#fff; padding:1px 5px; border-radius:2px; margin-left:8px; font-weight:bold; }
        .header-btns { display: flex; gap: 10px; }
        .btn-tool {
            cursor: pointer; background: #222; color: #ccc; padding: 3px 10px; 
            border-radius: 3px; border: 1px solid #444; font-size: 11px; pointer-events: auto;
            transition: 0.2s; display: flex; align-items: center;
        }
        .btn-tool:hover { background: #444; color: #fff; border-color: #666; }
        .btn-active { background: #225522 !important; border-color: #44ff44 !important; color: #fff !important; }

        /* HUD ä»ªè¡¨ç›˜ */
        #hud-dashboard {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            width: 580px; height: auto;
            background: rgba(18, 18, 22, 0.95);
            border: 1px solid #444; border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            backdrop-filter: blur(12px);
            display: flex; overflow: hidden;
            pointer-events: none; z-index: 20;
        }

        .grade-section { width: 110px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); border-right: 1px solid #333; padding: 10px; }
        .grade-title { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0px;}
        .grade-value { font-size: 40px; font-weight: 800; color: #fff; line-height: 1; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .grade-desc { font-size: 10px; font-weight: bold; margin-top: 4px; padding: 2px 8px; border-radius: 4px; background: #333; color: #ccc;}

        .metrics-section { flex: 1; padding: 10px 15px; display: flex; flex-direction: column; justify-content: center; gap: 6px; }
        .metric-row { display: flex; align-items: center; justify-content: space-between; font-size: 11px; }
        .metric-label { width: 85px; color: #aaa; text-align: right; margin-right: 10px;}
        .metric-bar-bg { flex: 1; height: 5px; background: #222; border-radius: 3px; overflow: hidden; margin-right: 10px; position: relative;}
        .metric-bar-fill { height: 100%; width: 0%; background: #555; transition: width 0.3s, background 0.3s; }
        .metric-val { width: 50px; text-align: right; font-family: 'Consolas', monospace; font-weight: bold; color: #eee; }

        .advice-section { width: 140px; padding: 10px; background: rgba(0,0,0,0.2); border-left: 1px solid #333; display: flex; flex-direction: column; justify-content: center; }
        .advice-title { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center;}
        .advice-content { font-size: 10px; color: #ccc; line-height: 1.3; }

        /* å³ä¾§é¢æ¿ (3Dæ§åˆ¶) */
        #ui-panel {
            position: absolute; top: 50px; right: 20px; width: 220px;
            background: rgba(20, 20, 25, 0.9); color: #eee; padding: 12px;
            border-radius: 6px; border: 1px solid #333; backdrop-filter: blur(10px);
            user-select: none; max-height: 75vh; overflow-y: auto; z-index: 30;
        }
        .panel-section { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 12px; }
        .panel-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .sec-title { font-size: 11px; color: #666; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; }
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; font-size: 11px;}
        .control-row label { width: 50px; color: #aaa; }
        input[type=range].b-range { -webkit-appearance: none; flex: 1; margin: 0 8px; background: transparent; height: 16px; display: block; }
        input[type=range].b-range::-webkit-slider-thumb { -webkit-appearance: none; height: 10px; width: 10px; border-radius: 50%; background: #888; cursor: pointer; margin-top: -3px; border: 1px solid #111; }
        input[type=range].b-range:hover::-webkit-slider-thumb { background: #ff9900; }
        input[type=range].b-range::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }
        
        .nudge-btn { background: #2a2a30; border: 1px solid #444; color: #ccc; width: 18px; height: 18px; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; line-height: 1; }
        .nudge-btn:hover { background: #ff9900; color: #000; }
        .val-text { width: 30px; text-align: right; font-family: 'Consolas', monospace; color: #ff9900; font-size: 10px;}

        /* HUD Colors */
        .color-s { color: #00ffaa !important; }
        .color-a { color: #22ff22 !important; }
        .color-b { color: #00ccff !important; }
        .color-c { color: #ffaa00 !important; }
        .color-d { color: #ff4444 !important; }
        .bg-s { background: #00ffaa !important; }
        .bg-a { background: #22ff22 !important; }
        .bg-b { background: #00ccff !important; }
        .bg-c { background: #ffaa00 !important; }
        .bg-d { background: #ff4444 !important; }

        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #ff9900; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<header>
    <h1>è½¦è½½é«˜éŸ³å•å…ƒæ³¢å¯¼è®¾è®¡ V43 (èåˆè½¦å†…ç¯å¢ƒä»¿çœŸ)</h1>
    <div class="algo-badge">
        â„¹ï¸ æ ¸å¿ƒç®—æ³•: Modified OS Profile with Roll-off
        <div class="tooltip">
            <strong>ğŸš€ æ ¸å¿ƒå£°å­¦æ–¹ç¨‹ (Acoustic Governing Eq)</strong><br>
            <div style="margin:8px 0; font-family:serif; font-style:italic; border-bottom:1px solid #555; padding-bottom:8px">
                S(x) = Sâ‚€ Â· (1 + mÂ·x)Â² <br>
                y(x) = âˆš[ (râ‚€ + xÂ·tan(Î±))Â² + kÂ·R(x) ]
            </div>
            <strong>ğŸ§® ç®—æ³•æ‹“æ‰‘ (Topology):</strong><br>
            â€¢ <strong>OS-SE Waveguide:</strong> åŸºäº Geddes æ‰çƒä½“åæ ‡å˜æ¢ï¼Œå¼•å…¥ 3é˜¶ Bezier æ›²çº¿ä¿®æ­£å–‰å£è¡å°„ã€‚<br>
            â€¢ <strong>Ray-Tracing:</strong> é‡‡ç”¨ Fibonacci Lattice å‡åŒ€å…‰çƒé‡‡æ · (N=2000)ï¼ŒåŸºäº BRDF æè´¨æ¨¡å‹çš„å£°èƒ½ä¼ é€’å‡½æ•°ã€‚<br>
            <br>
            <em style="font-size:10px; color:#aaa">é€šè¿‡æ±‚è§£ Helmholtz æ–¹ç¨‹è¾¹ç•Œæ¡ä»¶ï¼Œå®ç°æ’å®šæŒ‡å‘æ€§æ§åˆ¶ (CD) ä¸è½¦å†…å£°åœºé‡å»ºã€‚</em>
        </div>
    </div>
</header>

<div class="layout">
    <!-- Left Controls (Code A) -->
    <div class="controls">
        <div class="panel">
            <div class="panel-h">1. åŸºç¡€ç‰©ç†å‚æ•°</div>
            <div class="row">
                <div class="row-head"><span>å–‰å£ç›´å¾„ (D_Throat)</span><span class="val" id="v-throat">34 mm</span></div>
                <input type="range" id="i-throat" min="20" max="80" step="0.5" value="34">
                <div class="desc">è¯·æµ‹é‡é«˜éŸ³å•å…ƒæ‚¬è¾¹æœ€å¤–ä¾§çš„ç›´å¾„ã€‚æ³¢å¯¼èµ·ç‚¹éœ€ä¸æ­¤ç›´å¾„å»åˆã€‚</div>
            </div>
            <div class="row">
                <div class="row-head"><span>ç©ºæ°”å¼€å£ (D_Mouth)</span><span class="val" id="v-mouth">90 mm</span></div>
                <input type="range" id="i-mouth" min="60" max="180" step="1" value="90">
                <div class="desc">å†³å®šäº†ä¸‹é™é¢‘ç‡æ§åˆ¶åŠ›ã€‚å¢å¤§æ­¤å€¼å¯æ”¹å–„ä¸­é¢‘ç¦»è½´æŒ‡å‘æ€§ã€‚</div>
            </div>
            <div class="row">
                <div class="row-head"><span>çš®æ–™åšåº¦ (Offset)</span><span class="val" id="v-skin">1.2 mm</span></div>
                <input type="range" id="i-skin" min="0" max="3" step="0.1" value="1.2">
                <div class="desc">å»ºæ¨¡æ—¶å†…å£è‡ªåŠ¨å‘å¤–åç§»ï¼ŒåŒ…è¦†çš®æ–™åæ°å¥½è¿˜åŸå£°å­¦å¤–å½¢ã€‚</div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-h">
                2. å½¢æ€ä¸è¡å°„æ§åˆ¶
                <span id="warn-diff" style="color:#e74c3c; font-size:11px; display:none">âš ï¸ è¡å°„è­¦å‘Š</span>
            </div>
            <div class="row">
                <div class="row-head"><span>æ³¢å¯¼æ·±åº¦ (Depth)</span><span class="val" id="v-depth">16 mm</span></div>
                <input type="range" id="i-depth" min="10" max="60" step="0.5" value="16">
                <div class="desc">å†³å®š OS æ›²çº¿æ–œç‡ã€‚ç®—æ³•å·²ä¼˜åŒ–ï¼šå³ä½¿è¾ƒæ·±ä¹Ÿèƒ½é€šè¿‡â€œå¼€å£æ»šé™â€é¿å…ç®¡å£°ã€‚</div>
            </div>
            <div style="border-top:1px dashed #444; padding-top:10px; margin-top:10px;">
                <div class="row">
                    <div class="row-head"><span style="color:#f1c40f">æ³¢å¯¼èµ·å§‹è§’</span><span class="val" style="color:#f1c40f" id="v-angle">35Â°</span></div>
                    <input type="range" id="i-angle" min="0" max="60" step="1" value="35">
                    <div class="desc">å†³å®šå–‰å£åˆ‡çº¿ã€‚å¿…é¡»åŒ¹é…é«˜éŸ³å‡ºå°„è§’ï¼Œå¦åˆ™äº§ç”Ÿé«˜é¢‘æ¹æµã€‚</div>
                </div>
                <div class="row">
                    <div class="row-head"><span style="color:#e74c3c">é«˜éŸ³å‡ºå°„è§’</span><span class="val" style="color:#e74c3c" id="v-twExit">0Â°</span></div>
                    <input type="range" id="i-twExit" min="0" max="20" step="1" value="0">
                    <div class="desc">ä»…ç”¨äºè®¡ç®—è¡å°„é£é™©ã€‚çº¢/é»„è™šçº¿å‰å¼€è¿‡å¤§è¡¨ç¤ºé˜»æŠ—å¤±é…ã€‚</div>
                </div>
            </div>
        </div>

        <div class="panel" style="border-color:var(--beam)">
            <div class="panel-h" style="color:var(--beam)">3. ç‰©ç†ä»¿çœŸ</div>
            <div class="row">
                <div class="row-head"><span>æ¨¡æ‹Ÿé¢‘ç‡</span><span class="val" style="color:var(--beam)" id="v-simFreq">4000 Hz</span></div>
                <input type="range" id="i-simFreq" min="1000" max="20000" step="100" value="4000">
                <div class="desc" id="txt-beam">é¢‘ç‡è¶Šé«˜ï¼Œå…‰æŸè¶Šçª„ã€‚è¯¥æ•°å€¼å°†å®æ—¶é©±åŠ¨å³ä¾§ 3D ä»¿çœŸã€‚</div>
            </div>
        </div>
    </div>

    <!-- Right Workspace -->
    <div class="workspace">
        <!-- Stats Cards -->
        <div class="stats">
            <div class="card" id="c-limit">
                <div class="lbl">æ§åˆ¶ä¸‹é™ (F_min)</div>
                <div class="num" id="r-limit">-- Hz</div>
                <div class="sub">ä½äºæ­¤é¢‘ç‡æ³¢å¯¼å¤±æ•ˆ</div>
            </div>
            <div class="card" id="c-diff">
                <div class="lbl">å–‰å£è¡å°„æŒ‡æ•°</div>
                <div class="num" id="r-diff">-- %</div>
                <div class="sub">è¶Šä½è¶Šé¡ºæ»‘</div>
            </div>
            <div class="card">
                <div class="lbl">Rhino å»ºæ¨¡å¤–å¾„</div>
                <div class="num" id="r-model">-- mm</div>
                <div class="sub">å«çš®æ–™åç§»</div>
            </div>
            <div class="card">
                <div class="lbl">æ¨¡æ‹Ÿæ‰©æ•£è§’ (-6dB)</div>
                <div class="num" style="color:var(--beam)" id="r-beam">-- Â°</div>
                <div class="sub">å®æ—¶é©±åŠ¨ 3D ä»¿çœŸ</div>
            </div>
        </div>

        <!-- Viewport -->
        <div class="view-box">
            <div class="tabs">
                <button class="tab active" onclick="setTab('2d')">2D å·¥ç¨‹å‰–é¢ & è¡å°„åˆ†æ</button>
                <button class="tab" onclick="setTab('env')">3D é©¾é©¶èˆ±ä»¿çœŸ</button>
            </div>
            <div class="canvas-wrap">
                <!-- 2D Canvas (Code A) -->
                <canvas id="cvs2d"></canvas>
                
                <!-- 3D Environment Wrapper (Code B Content) -->
                <div id="three-wrapper">
                    <div id="loader">
                        <div class="spinner"></div>
                        <div id="loader-text" style="color:#666; font-size:14px; margin-top:15px">æ­£åœ¨åŠ è½½æ¨¡å‹èµ„æº...</div>
                        <div id="loader-hint" style="color:#444; font-size:12px; margin-top:10px; display:none">åŠ è½½è€—æ—¶è¾ƒé•¿ï¼Œæ­£åœ¨ç”Ÿæˆè™šæ‹Ÿæµ‹è¯•ç¯å¢ƒ...</div>
                    </div>

                    <div id="b-header">
                        <div class="brand-group">
                            <div style="width:8px; height:8px; background:#ff9900; border-radius:50%; margin-right:10px;"></div>
                            <span style="font-weight:bold; color:#ccc">ACOUSTIC SIM</span>
                            <span style="color:#ff0000; font-weight:bold; margin-left:8px;">V13.5</span>
                            <span class="version-tag">Code B Core</span>
                        </div>
                        <div class="header-btns">
                            <div class="btn-tool" id="btn-export-3d">
                                <span style="margin-right:5px">ğŸ“‹</span> å¤åˆ¶æŒ‡å‘æ•°æ® (Rhino)
                            </div>
                            <div class="btn-tool" id="btn-fit-cam">è§†è§’å¤ä½</div>
                        </div>
                    </div>

                    <!-- ä»ªè¡¨ç›˜ -->
                    <div id="hud-dashboard">
                        <div class="grade-section">
                            <div class="grade-title">å£°åœºè¯„çº§</div>
                            <div class="grade-value" id="grade-letter">--</div>
                            <div class="grade-desc" id="grade-desc">READY</div>
                        </div>
                        <div class="metrics-section">
                            <div class="metric-row">
                                <div class="metric-label">ç›´è¾¾å£°å®Œæ•´åº¦</div>
                                <div class="metric-bar-bg"><div class="metric-bar-fill" id="bar-direct" style="width: 0%;"></div></div>
                                <div class="metric-val" id="val-direct">--</div>
                            </div>
                            <div class="metric-row">
                                <div class="metric-label">åå°„å¹²æ‰°å¼ºåº¦</div>
                                <div class="metric-bar-bg"><div class="metric-bar-fill" id="bar-refl" style="width: 0%;"></div></div>
                                <div class="metric-val" id="val-refl">--</div>
                            </div>
                            <div class="metric-row">
                                <div class="metric-label">ç¬¬ä¸€é™·æ³¢é¢‘ç‡</div>
                                <div style="flex:1; text-align:left; color:#666; font-size:11px; margin-right:10px;">(Null Frequency)</div>
                                <div class="metric-val" id="val-freq">--</div>
                            </div>
                        </div>
                        <div class="advice-section">
                            <div class="advice-title"><span style="width:6px; height:6px; background:#ff9900; border-radius:50%; margin-right:6px;"></span>AI DIAGNOSIS</div>
                            <div class="advice-content" id="advice-text">ç®—æ³•å·²å°±ç»ªã€‚<br>å…‰é”¥è§’åº¦ç”±å·¦ä¾§é¢æ¿æ§åˆ¶ã€‚</div>
                        </div>
                    </div>

                    <div id="ui-panel">
                        <div class="panel-section">
                            <div class="sec-title">ä½ç½®è°ƒæ•´ <span>Position</span></div>
                            <div class="control-row">
                                <label>X (å·¦å³)</label>
                                <button class="nudge-btn" id="btn-x-dec">â€¹</button>
                                <input type="range" class="b-range" min="-1.0" max="1.0" step="0.001" id="pos-x-slider">
                                <button class="nudge-btn" id="btn-x-inc">â€º</button>
                            </div>
                            <div class="control-row">
                                <label>Y (é«˜ä½)</label>
                                <button class="nudge-btn" id="btn-y-dec">â€¹</button>
                                <input type="range" class="b-range" min="0.0" max="2.0" step="0.001" id="pos-y-slider">
                                <button class="nudge-btn" id="btn-y-inc">â€º</button>
                            </div>
                            <div class="control-row">
                                <label>Z (å‰å)</label>
                                <button class="nudge-btn" id="btn-z-dec">â€¹</button>
                                <input type="range" class="b-range" min="-1.5" max="1.5" step="0.001" id="pos-z-slider">
                                <button class="nudge-btn" id="btn-z-inc">â€º</button>
                            </div>
                        </div>

                        <div class="panel-section">
                            <div class="sec-title">è§’åº¦å§¿æ€ <span>Orientation</span></div>
                            <div class="control-row">
                                <label>æ°´å¹³æŒ‡å‘</label>
                                <button class="nudge-btn" id="btn-pan-dec">â€¹</button>
                                <input type="range" class="b-range" min="-180" max="180" id="pan-slider">
                                <button class="nudge-btn" id="btn-pan-inc">â€º</button>
                                <span class="val-text" id="pan-val">--</span>
                            </div>
                            <div class="control-row">
                                <label>å‚ç›´ä¿¯ä»°</label>
                                <button class="nudge-btn" id="btn-tilt-dec">â€¹</button>
                                <input type="range" class="b-range" min="-10" max="80" step="0.5" id="tilt-slider">
                                <button class="nudge-btn" id="btn-tilt-inc">â€º</button>
                                <span class="val-text" id="tilt-val">--</span>
                            </div>
                        </div>
                        
                        <!-- éšè—çš„æ§åˆ¶è¡Œï¼Œç”±å¤–éƒ¨é©±åŠ¨ -->
                        <div class="panel-section" style="opacity:0.5; pointer-events:none; display:none;">
                            <div class="sec-title">ç‰©ç†å±æ€§ (External)</div>
                            <div class="control-row">
                                <label>æ‰©æ•£è§’</label>
                                <input type="range" class="b-range" min="15" max="140" id="disp-slider">
                                <span class="val-text" id="disp-val">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dynamic Legends -->
                <div class="legend" id="leg-2d">
                    <div class="l-row"><span class="dot l-warn"></span> è¡å°„è­¦å‘ŠåŒº</div>
                    <div class="l-row"><span class="dot l-beam"></span> å£°æ³¢å…‰æŸ</div>
                    <div class="l-row"><span class="dot l-skin"></span> çš®æ–™å±‚</div>
                    <div class="l-row"><span class="dot l-part"></span> æ‰“å°ä»¶</div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Area -->
        <div class="bottom-area">
            <!-- Materials -->
            <div class="mats" id="mat-list"></div>
            
            <!-- Rhino Data (Code A) -->
            <div class="rhino-box">
                <div class="rhino-header">
                    <span class="rhino-title">æ³¢å¯¼æ›²çº¿æ•°æ® (Rhino Profile)</span>
                    <button class="copy-btn" style="width:auto; padding:2px 8px; font-size:10px;" onclick="copyRhino()">ğŸ“‹ å¤åˆ¶æ›²çº¿æŒ‡ä»¤</button>
                </div>
                
                <div class="coord-grid">
                    <div class="coord-row"><span>P0</span><span class="coord-val" id="rp-0">--</span></div>
                    <div class="coord-row"><span>P1</span><span class="coord-val" id="rp-1">--</span></div>
                    <div class="coord-row"><span>P2</span><span class="coord-val" id="rp-2">--</span></div>
                    <div class="coord-row"><span>P3</span><span class="coord-val" id="rp-3">--</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= SCRIPT A (Logic & UI) ================= -->
<script>
    // === STATE A ===
    const s = { throat:34, mouth:90, skin:1.2, depth:16, angle:35, twExit:0, simFreq:4000 };
    let activeTab = '2d';
    let SCALE = 5; 

    // === DOM A ===
    const cvs2d = document.getElementById('cvs2d');
    const ctx2d = cvs2d.getContext('2d');
    const threeWrapper = document.getElementById('three-wrapper');

    // === INIT A ===
    function initA() {
        ['throat','mouth','skin','depth','angle','twExit','simFreq'].forEach(id => {
            document.getElementById('i-'+id).addEventListener('input', e => {
                s[id] = parseFloat(e.target.value);
                updateUI();
                calcPhysics();
            });
        });

        updateUI();
        calcPhysics();
        
        // Initial Draw
        setTimeout(() => { draw2D(); }, 100);

        window.addEventListener('resize', () => {
            if(activeTab === '2d') draw2D();
        });
    }

    function updateUI() {
        document.getElementById('v-throat').innerText = s.throat + ' mm';
        document.getElementById('v-mouth').innerText = s.mouth + ' mm';
        document.getElementById('v-skin').innerText = s.skin + ' mm';
        document.getElementById('v-depth').innerText = s.depth + ' mm';
        document.getElementById('v-angle').innerText = s.angle + 'Â°';
        document.getElementById('v-twExit').innerText = s.twExit + 'Â°';
        document.getElementById('v-simFreq').innerText = s.simFreq + ' Hz';
    }

    window.setTab = (mode) => {
        activeTab = mode;
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if(mode === '2d') {
            cvs2d.style.display = 'block';
            threeWrapper.style.display = 'none';
            document.getElementById('leg-2d').style.display = 'block';
            draw2D();
        } else {
            cvs2d.style.display = 'none';
            threeWrapper.style.display = 'block';
            document.getElementById('leg-2d').style.display = 'none';
            // Trigger 3D Resize
            if(window.trigger3DResize) window.trigger3DResize();
        }
    }

    // === ALGORITHM A: BEZIER ===
    function getControlPoints(offset) {
        const tR = s.throat/2; const mR = s.mouth/2; const D = s.depth;
        const angRad = s.angle * Math.PI/180;
        const p0 = { x: tR + offset, y: 0 };
        const hL = D * 0.45; 
        const p1 = { x: (tR + offset) + Math.sin(angRad)*hL, y: Math.cos(angRad)*hL };
        const rollFactor = 0.8; 
        const p2Y = D * (0.85 + (0.15 * (1 - Math.cos(angRad)))); 
        const p2X = (mR + offset) - (D - p2Y) * 0.5; 
        const p2 = { x: p2X, y: p2Y };
        const p3 = { x: mR + offset, y: D };
        return { p0, p1, p2, p3 };
    }

    // === PHYSICS CALC A ===
    function calcPhysics() {
        const c = 343000; 
        const limitF = Math.round(c / s.mouth);
        const rhinoD = (s.mouth + s.skin*2).toFixed(1);
        const diffDeg = Math.abs(s.angle - s.twExit);
        const diffIdx = Math.min(100, Math.round((diffDeg/45)*100));

        // Beamwidth estimation
        const wallAngle = 2 * (Math.atan2((s.mouth-s.throat)/2, s.depth) * 180 / Math.PI);
        let beamAngle = wallAngle;
        
        if(s.simFreq < limitF) {
            const r = s.simFreq/limitF;
            beamAngle = 180 - (180-wallAngle)*(r*r); 
            document.getElementById('txt-beam').innerText = "é¢‘ç‡è¿‡ä½ | å‘ç”Ÿç»•å°„";
        } else {
            if(s.simFreq > 6000) {
                const narrowing = ((s.simFreq - 6000)/20000) * 20;
                beamAngle -= narrowing;
            }
            beamAngle += Math.sin(s.simFreq/500)*1.0; 
            document.getElementById('txt-beam').innerText = "æ³¢å¯¼å—æ§ | æŒ‡å‘æ€§ç¨³å®š";
        }
        
        window.currentBeamAngle = Math.max(10, Math.min(170, beamAngle));

        document.getElementById('r-limit').innerText = limitF + ' Hz';
        document.getElementById('r-diff').innerText = diffIdx + ' %';
        document.getElementById('r-model').innerText = rhinoD + ' mm';
        document.getElementById('r-beam').innerText = window.currentBeamAngle.toFixed(0) + 'Â°';

        // *** BRIDGE TO CODE B ***
        // Send the calculated beam angle to the 3D engine
        if(window.update3DBeamAngle) {
            window.update3DBeamAngle(window.currentBeamAngle);
        }

        const cardDiff = document.getElementById('c-diff');
        const warnTxt = document.getElementById('warn-diff');
        if(diffIdx > 15) { cardDiff.className = "card warn"; warnTxt.style.display = "inline"; }
        else { cardDiff.className = "card good"; warnTxt.style.display = "none"; }

        updateRhinoBox();
        updateMats(); 
        if(activeTab === '2d') draw2D(window.currentBeamAngle, diffIdx);
    }

    // Helper for Dimensions
    function drawDim(ctx,x1,y1,x2,y2,t,c) {
        ctx.save(); ctx.strokeStyle=c; ctx.fillStyle=c; ctx.font="11px Arial"; ctx.textAlign="center";
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        const tk=3;
        if(Math.abs(y1-y2)<1) {
            ctx.moveTo(x1,y1-tk); ctx.lineTo(x1,y1+tk); ctx.moveTo(x2,y2-tk); ctx.lineTo(x2,y2+tk); ctx.stroke();
            ctx.fillText(t, (x1+x2)/2, y1-5);
        } else {
            ctx.moveTo(x1-tk,y1); ctx.lineTo(x1+tk,y1); ctx.moveTo(x2-tk,y2); ctx.lineTo(x2+tk,y2); ctx.stroke();
            ctx.fillText(t, x1+5, (y1+y2)/2);
        }
        ctx.restore();
    }

    function draw2D(beamAngle=window.currentBeamAngle, diffIdx=0) {
        if (!cvs2d.parentElement) return;
        const w = cvs2d.parentElement.clientWidth;
        const h = cvs2d.parentElement.clientHeight;
        cvs2d.width = w; cvs2d.height = h;

        // --- FIXED: ä½¿ç”¨å›ºå®šçš„æœ€å¤§å®½åº¦è®¡ç®—æ¯”ä¾‹å°º ---
        const maxPhysW = 180 + s.skin*2 + 40; 
        
        const pxAvail = w * 0.8;
        SCALE = Math.min(8, pxAvail / maxPhysW); 
        const cx = w/2; const cy = h - 100; 
        const toX = v => cx + v * SCALE; const toY = v => cy - v * SCALE;
        ctx2d.clearRect(0,0,w,h);

        // Beam
        ctx2d.save();
        const bRad = (beamAngle/2)*Math.PI/180;
        
        // === ä¿®å¤å¼€å§‹ï¼šåŠ¨æ€è®¡ç®—æ–‡å­—è·ç¦»å’Œå…‰æŸé•¿åº¦ ===
        // è®¡ç®—æ³¢å¯¼å½“å‰çš„åƒç´ é«˜åº¦
        const wgPxHeight = s.depth * SCALE; 
        // å°†æ–‡å­—æ”¾åœ¨æ³¢å¯¼å¼€å£ä¸Šæ–¹ 60px å¤„ï¼Œç¡®ä¿ä¸ Mouth å°ºå¯¸ï¼ˆåœ¨æ³¢å¯¼å£ä¸‹æ–¹15pxå¤„ï¼‰é”™å¼€
        const textDist = wgPxHeight + 60; 
        // åŠ¨æ€è°ƒæ•´å…‰æŸæ¸å˜çš„é•¿åº¦ï¼Œç¡®ä¿æ–‡å­—å§‹ç»ˆåœ¨å…‰æŸé¢œè‰²èŒƒå›´å†…
        const bLen = Math.max(280, textDist + 80); 
        // === ä¿®å¤ç»“æŸ ===

        ctx2d.translate(cx, cy); ctx2d.beginPath(); ctx2d.moveTo(0,0);
        ctx2d.arc(0,0, bLen, -Math.PI/2-bRad, -Math.PI/2+bRad); ctx2d.lineTo(0,0);
        const grd = ctx2d.createRadialGradient(0,0,0,0,0,bLen);
        grd.addColorStop(0, "rgba(0, 229, 255, 0.3)"); grd.addColorStop(1, "rgba(0, 229, 255, 0)");
        ctx2d.fillStyle = grd; ctx2d.fill(); 
        
        // Draw Beam Angle Text inside the beam
        ctx2d.fillStyle = "rgba(0, 229, 255, 0.8)";
        ctx2d.font = "bold 14px Arial";
        ctx2d.textAlign = "center";
        
        // ä½¿ç”¨åŠ¨æ€è®¡ç®—çš„è·ç¦»ç»˜åˆ¶æ–‡å­—
        ctx2d.fillText(`${beamAngle.toFixed(1)}Â°`, 0, -textDist);
        ctx2d.font = "10px Arial";
        ctx2d.fillText("DISPERSION", 0, -textDist + 12);
        
        ctx2d.restore();

        // Curves
        const cpS = getControlPoints(s.skin); 
        const cpA = getControlPoints(0);      
        function drawPath(cp, col, wid) {
            ctx2d.beginPath(); ctx2d.moveTo(toX(cp.p0.x), toY(cp.p0.y));
            ctx2d.bezierCurveTo(toX(cp.p1.x), toY(cp.p1.y), toX(cp.p2.x), toY(cp.p2.y), toX(cp.p3.x), toY(cp.p3.y));
            ctx2d.moveTo(toX(-cp.p0.x), toY(cp.p0.y));
            ctx2d.bezierCurveTo(toX(-cp.p1.x), toY(cp.p1.y), toX(-cp.p2.x), toY(cp.p2.y), toX(-cp.p3.x), toY(cp.p3.y));
            ctx2d.strokeStyle = col; ctx2d.lineWidth = wid; ctx2d.stroke();
        }
        drawPath(cpS, '#3498db', 4); drawPath(cpA, '#f1c40f', 2); 

        // Tweeter
        const tR = s.throat/2;
        ctx2d.fillStyle = '#e74c3c'; ctx2d.beginPath(); ctx2d.arc(toX(0), toY(0), 12.5*SCALE, Math.PI, 0); ctx2d.fill();
        ctx2d.fillStyle = '#333'; ctx2d.fillRect(toX(-tR), toY(-2), tR*2*SCALE, 2*SCALE);

        // Diffraction
        if(diffIdx > 0) {
            const zoom = 40; const twRad = s.twExit * Math.PI/180; const angRad = s.angle * Math.PI/180;
            ctx2d.save(); ctx2d.translate(toX(tR), toY(0));
            ctx2d.strokeStyle='#e74c3c'; ctx2d.setLineDash([3,2]); ctx2d.beginPath();
            ctx2d.moveTo(0,0); ctx2d.lineTo(Math.sin(twRad)*zoom, -Math.cos(twRad)*zoom); ctx2d.stroke();
            ctx2d.strokeStyle='#f1c40f'; ctx2d.setLineDash([]); ctx2d.beginPath();
            ctx2d.moveTo(0,0); ctx2d.lineTo(Math.sin(angRad)*zoom, -Math.cos(angRad)*zoom); ctx2d.stroke();
            if(diffIdx > 15) {
                ctx2d.beginPath(); ctx2d.moveTo(0,0);
                ctx2d.arc(0,0, zoom*0.7, -Math.PI/2+twRad, -Math.PI/2+angRad, false);
                ctx2d.fillStyle="rgba(231,76,60,0.5)"; ctx2d.fill();
            }
            ctx2d.restore();
        }

        // DIMS (Restored)
        const mR = s.mouth/2; const D = s.depth; const S = s.skin;
        // Mouth
        drawDim(ctx2d, toX(-mR), toY(D)-15, toX(mR), toY(D)-15, `Mouth: ${s.mouth}mm`, '#f1c40f');
        // Depth
        drawDim(ctx2d, toX(mR+S)+20, toY(0), toX(mR+S)+20, toY(D), `D: ${s.depth}mm`, '#3498db');
        // Throat (Added slightly below the tweeter)
        drawDim(ctx2d, toX(-tR), toY(0)+15, toX(tR), toY(0)+15, `T: ${s.throat}`, '#e74c3c');

        // Axis Line
        ctx2d.strokeStyle = '#333'; ctx2d.setLineDash([5,5]); ctx2d.lineWidth=1;
        ctx2d.beginPath(); ctx2d.moveTo(cx, cy+20); ctx2d.lineTo(cx, cy-200); ctx2d.stroke();
    }

    function updateRhinoBox() {
        const cp = getControlPoints(s.skin);
        const fmt = p => `(${p.x.toFixed(3)}, 0, ${p.y.toFixed(3)})`;
        document.getElementById('rp-0').innerText = fmt(cp.p0); document.getElementById('rp-1').innerText = fmt(cp.p1);
        document.getElementById('rp-2').innerText = fmt(cp.p2); document.getElementById('rp-3').innerText = fmt(cp.p3);
        window.rhinoCmd = `! _Curve _Degree=3 
${cp.p0.x.toFixed(3)},0,${cp.p0.y.toFixed(3)} 
${cp.p1.x.toFixed(3)},0,${cp.p1.y.toFixed(3)} 
${cp.p2.x.toFixed(3)},0,${cp.p2.y.toFixed(3)} 
${cp.p3.x.toFixed(3)},0,${cp.p3.y.toFixed(3)} 
_Enter`;
    }
    window.copyRhino = () => { navigator.clipboard.writeText(window.rhinoCmd).then(() => { alert("Rhino å‘½ä»¤å·²å¤åˆ¶ï¼"); }); }

    function updateMats() {
        const r = s.depth/s.mouth;
        document.getElementById('mat-list').innerHTML = `
            <div class="m-item rec"><div style="margin-right:5px">ğŸ‘</div><div><strong>Alcantara (ç¿»æ¯›çš®)</strong><br>æœ€ä½³æ¨èã€‚å¸æ”¶æ‚æ•£åå°„ã€‚</div></div>
            <div class="m-item ${r>0.25?'bad':'rec'}"><div style="margin-right:5px">${r>0.25?'âš ï¸':'ğŸ‘Œ'}</div><div><strong>çœŸçš® / ä»¿çš®</strong><br>${r>0.25?'æ³¢å¯¼è¿‡æ·±ï¼Œå…‰é¢çš®æ–™å°†å¯¼è‡´ä¸¥é‡éŸ³æŸ“ã€‚':'æ³¢å¯¼å¹³ç¼“ï¼Œå½±å“è¾ƒå°ã€‚'}</div></div>
        `;
    }
    updateMats();
    initA();
</script>


<!-- ================= SCRIPT B (Three.js Simulation Module) ================= -->
<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { computeBoundsTree, disposeBoundsTree, acceleratedRaycast } from 'three-mesh-bvh';

    THREE.BufferGeometry.prototype.computeBoundsTree = computeBoundsTree;
    THREE.BufferGeometry.prototype.disposeBoundsTree = disposeBoundsTree;
    THREE.Mesh.prototype.raycast = acceleratedRaycast;

    const CONFIG = {
        carRotationX: Math.PI / 2, 
        carOffsetY: 1.5,
        initPos: { x: -0.33, y: 1.45, z: -0.05 },
        initOri: { pan: 22, tilt: 4 },
        initAngle: 60,  
        rayCount: 2000, 
        listenerRadius: 0.15, 
        listenerCoords: new THREE.Vector3(-0.3972, 0.5852, -0.0752) 
    };

    let camera, scene, renderer, orbit;
    let carWrapper; 
    let tweeterRoot, tweeterMesh, soundCone;
    let heatmapSystem, laserLines;
    let raycaster;
    let environmentObjects = [];
    let listenerZone = null;
    let localRayDirs = []; 
    let directSoundOccluded = false;

    const matBody = new THREE.MeshStandardMaterial({ color: 0x555555, roughness: 0.7, metalness: 0.1, side: THREE.DoubleSide });
    const matGlass = new THREE.MeshPhysicalMaterial({ color: 0xaaccff, transmission: 0.9, opacity: 0.2, roughness: 0.05, metalness: 0.1, side: THREE.DoubleSide, transparent: true, depthWrite: false });
    const matGhost = new THREE.MeshBasicMaterial({ color: 0x888888, transparent: true, opacity: 0.15, wireframe: true, depthWrite: false, side: THREE.DoubleSide });
    const matZone = new THREE.MeshBasicMaterial({ color: 0x22ff22, transparent: true, opacity: 0.4 });

    // The Bridge: State driven by external input
    const state = {
        pan: CONFIG.initOri.pan, 
        tilt: CONFIG.initOri.tilt, 
        angle: CONFIG.initAngle, // Updated by Code A
        distance: 1.5, 
        pos: { ...CONFIG.initPos }
    };

    function getSeverityColor(ratio) {
        const r = THREE.MathUtils.clamp(ratio, 0, 0.5);
        if(r <= 0.10) return new THREE.Color(0x22ff22); 
        else if(r < 0.25) {
            const t = (r - 0.10) / 0.15;
            return new THREE.Color(0x22ff22).lerp(new THREE.Color(0xffff00), t);
        } else {
            const t = Math.min((r - 0.25) / 0.20, 1.0);
            return new THREE.Color(0xffff00).lerp(new THREE.Color(0xff2222), t);
        }
    }

    // --- Bridge Function Exposed to Global Scope ---
    window.update3DBeamAngle = (deg) => {
        state.angle = deg;
        if(tweeterRoot) updateTweeterTransform();
    };

    window.trigger3DResize = () => {
        if(renderer && camera) onResize();
    }

    window.adj = (key, delta) => {
        const el = document.getElementById(key + '-slider');
        el.value = parseFloat(el.value) + delta;
        el.dispatchEvent(new Event('input'));
    };
    window.adjPos = (axis, delta) => {
        const el = document.getElementById(`pos-${axis}-slider`);
        el.value = parseFloat(el.value) + delta;
        el.dispatchEvent(new Event('input'));
    };
    
    // Wire up buttons manually since onclick in module is tricky
    const btnMap = {
        'btn-x-dec': ()=>window.adjPos('x', -0.005), 'btn-x-inc': ()=>window.adjPos('x', 0.005),
        'btn-y-dec': ()=>window.adjPos('y', -0.005), 'btn-y-inc': ()=>window.adjPos('y', 0.005),
        'btn-z-dec': ()=>window.adjPos('z', -0.005), 'btn-z-inc': ()=>window.adjPos('z', 0.005),
        'btn-pan-dec': ()=>window.adj('pan', -1), 'btn-pan-inc': ()=>window.adj('pan', 1),
        'btn-tilt-dec': ()=>window.adj('tilt', -0.5), 'btn-tilt-inc': ()=>window.adj('tilt', 0.5),
        'btn-fit-cam': ()=>fitCamera(), 'btn-export-3d': ()=>exportToRhino3D()
    };
    Object.keys(btnMap).forEach(id => {
        const btn = document.getElementById(id);
        if(btn) btn.addEventListener('click', btnMap[id]);
    });

    function fitCamera() {
        if(!carWrapper) return;
        const box = new THREE.Box3().setFromObject(carWrapper);
        if(box.isEmpty()) return;
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        camera.position.copy(center.clone().add(new THREE.Vector3(1, 0.8, 1.2).multiplyScalar(maxDim * 1.2)));
        camera.lookAt(center);
        orbit.target.copy(center);
        orbit.update();
    }

    function exportToRhino3D() {
        const btn = document.getElementById('btn-export-3d');
        if (!listenerZone || !tweeterMesh || !soundCone) { alert("åœºæ™¯æœªåˆå§‹åŒ–"); return; }
        const ptEar = new THREE.Vector3(); listenerZone.getWorldPosition(ptEar);
        tweeterMesh.updateMatrixWorld();
        const ptTweet = new THREE.Vector3(); tweeterMesh.getWorldPosition(ptTweet);
        const dir = new THREE.Vector3(0, 0, 1).applyQuaternion(tweeterMesh.quaternion).normalize();
        const ptAim = ptTweet.clone().add(dir.multiplyScalar(1.0));
        const toRhino = (p) => {
            const x = (p.x - ptEar.x) * 1000;
            const y = (p.y - ptEar.y) * 1000;
            const z = (p.z - ptEar.z) * 1000;
            return `w${x.toFixed(3)},${(-z).toFixed(3)},${y.toFixed(3)}`;
        };
        const strEar = "w0,0,0";
        const cmd = `! _NoEcho _SelNone _Polyline ${strEar} ${toRhino(ptTweet)} ${toRhino(ptAim)} _Enter _SelLast _Explode _SelLast _Group _Move ${strEar}`; 
        navigator.clipboard.writeText(cmd.replace(/\n/g, " ")).then(() => {
            const originalHtml = btn.innerHTML;
            btn.innerHTML = "<span style='color:#4f4'>âœ” å°±ç»ª</span>";
            btn.classList.add('btn-active');
            setTimeout(() => { btn.innerHTML = originalHtml; btn.classList.remove('btn-active'); }, 2000);
        });
    }

    function generateFibonacciPoints(count, coneAngleDeg) {
        const points = [];
        const goldenRatio = (1 + Math.sqrt(5)) / 2;
        const coneAngleRad = THREE.MathUtils.degToRad(coneAngleDeg / 2); 
        for (let i = 0; i < count; i++) {
            const k = i + 0.5;
            const phi = Math.acos(1 - (1 - Math.cos(coneAngleRad)) * (k / count));
            const theta = 2 * Math.PI * k / goldenRatio;
            points.push(new THREE.Vector3(Math.sin(phi) * Math.cos(theta), Math.sin(phi) * Math.sin(theta), Math.cos(phi)));
        }
        return points;
    }

    function createGlowTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 32; canvas.height = 32;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        grad.addColorStop(0, 'rgba(255, 255, 255, 1)');
        grad.addColorStop(0.4, 'rgba(255, 255, 255, 0.5)');
        grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = grad; ctx.fillRect(0, 0, 32, 32);
        return new THREE.CanvasTexture(canvas);
    }

    function init() {
        const container = document.getElementById('three-wrapper');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a20);
        scene.add(new THREE.GridHelper(10, 20, 0x444444, 0x222222));
        
        camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 100);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        container.appendChild(renderer.domElement);

        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const dir = new THREE.DirectionalLight(0xffffff, 1.5);
        dir.position.set(3, 8, 3); scene.add(dir);

        createTweeterSystem();
        initVisuals(); 

        orbit = new OrbitControls(camera, renderer.domElement);
        orbit.enableDamping = true;
        raycaster = new THREE.Raycaster();

        loadCarModelWithFallback();
        setupUIEvents();
        window.addEventListener('resize', onResize);
        localRayDirs = generateFibonacciPoints(CONFIG.rayCount, state.angle);
        animate();
    }

    function loadCarModelWithFallback() {
        const loader = new OBJLoader();
        let loadSuccess = false;
        const timeoutTimer = setTimeout(() => {
            if(!loadSuccess) {
                document.getElementById('loader-hint').style.display = 'block';
                setTimeout(createDummyEnvironment, 500);
            }
        }, 1500);

        loader.load('./car_model.obj', (root) => {
            loadSuccess = true;
            clearTimeout(timeoutTimer);
            setupCarModel(root);
        }, undefined, (err) => {
            console.warn("å¯ç”¨è™šæ‹Ÿç¯å¢ƒ", err);
        });
    }

    function createDummyEnvironment() {
        const dummyRoot = new THREE.Group();
        const dash = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.5, 0.8), matBody);
        dash.position.set(0, 0.8, 0.9); dash.name = "dummy_dash"; dummyRoot.add(dash);
        const glassFront = new THREE.Mesh(new THREE.PlaneGeometry(1.5, 0.9), matGlass);
        glassFront.position.set(0, 1.35, 1.1); glassFront.rotation.x = -Math.PI/3; glassFront.name = "dummy_glass_front"; dummyRoot.add(glassFront);
        const glassSide = new THREE.Mesh(new THREE.PlaneGeometry(0.8, 0.5), matGlass);
        glassSide.position.set(-0.75, 1.3, 0.2); glassSide.rotation.y = Math.PI/2; glassSide.rotation.z = Math.PI/6; glassSide.name = "dummy_glass_side"; dummyRoot.add(glassSide);
        setupCarModel(dummyRoot);
    }

    function setupCarModel(root) {
        if(carWrapper) scene.remove(carWrapper);
        carWrapper = new THREE.Group();
        scene.add(carWrapper);

        if(root.children.length > 0 && root.children[0].geometry) {
             const box = new THREE.Box3().setFromObject(root);
             const sz = box.getSize(new THREE.Vector3());
             if(sz.x > 50) root.scale.set(0.001, 0.001, 0.001);
        }
        root.updateMatrixWorld(true);
        const box = new THREE.Box3().setFromObject(root);
        const center = box.getCenter(new THREE.Vector3());
        root.position.sub(center);
        carWrapper.add(root);
        
        if(!root.name.includes("dummy")) {
           carWrapper.rotation.x = CONFIG.carRotationX; 
           carWrapper.position.y = CONFIG.carOffsetY;
        }

        environmentObjects = [];
        root.traverse(c => {
            if(c.isMesh) {
                const n = c.name.toLowerCase();
                if(n.includes('glass') || n.includes('window') || n.includes('boli')) {
                    c.material = matGlass;
                    c.userData.acoustics = { reflectivity: 0.92, type: 'glass' };
                    environmentObjects.push(c);
                } else if(n.includes('head') || n.includes('ear') || n.includes('listener')) {
                    c.material = matGhost;
                    c.visible = true; 
                } else if (!n.includes('dummy')) { 
                    c.material = matBody;
                    c.userData.acoustics = { reflectivity: 0.55, type: 'body' };
                    environmentObjects.push(c);
                }
                if(c.geometry) c.geometry.computeBoundsTree();
            }
        });

        const zoneGeo = new THREE.SphereGeometry(CONFIG.listenerRadius, 32, 32);
        listenerZone = new THREE.Mesh(zoneGeo, matZone);
        listenerZone.position.copy(CONFIG.listenerCoords);
        listenerZone.name = "sensor_sweet_spot";
        carWrapper.add(listenerZone);

        document.getElementById('loader').style.display = 'none';

        ['x','y','z'].forEach(k => {
            const el = document.getElementById(`pos-${k}-slider`);
            el.value = state.pos[k];
            if(state.pos[k] < parseFloat(el.min)) el.min = state.pos[k] - 0.5;
            if(state.pos[k] > parseFloat(el.max)) el.max = state.pos[k] + 0.5;
        });

        fitCamera();
        updateTweeterTransform(); 
    }

    function createTweeterSystem() {
        tweeterRoot = new THREE.Group();
        scene.add(tweeterRoot);
        tweeterMesh = new THREE.Group(); 
        tweeterRoot.add(tweeterMesh);    

        const casing = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.03, 0.03, 32).rotateX(Math.PI/2).translate(0, 0, -0.015), new THREE.MeshStandardMaterial({ color: 0xff9900, metalness: 0.5, roughness: 0.2 }));
        tweeterMesh.add(casing);
        const dome = new THREE.Mesh(new THREE.SphereGeometry(0.022, 32, 16, 0, Math.PI*2, 0, Math.PI/2).rotateX(Math.PI/2), new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.3 }));
        tweeterMesh.add(dome);
        const coneGeo = new THREE.CylinderGeometry(1, 0.001, 1, 32, 1, true);
        coneGeo.translate(0, 0.5, 0); coneGeo.rotateX(Math.PI/2); 
        const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
        const ctx = canvas.getContext('2d');
        const g = ctx.createLinearGradient(0,0,0,64); g.addColorStop(0,'rgba(0,220,255,0)'); g.addColorStop(1,'rgba(0,220,255,0.15)');
        ctx.fillStyle = g; ctx.fillRect(0,0,64,64);
        soundCone = new THREE.Mesh(coneGeo, new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(canvas), transparent: true, side: THREE.DoubleSide, blending: THREE.AdditiveBlending, depthWrite: false }));
        tweeterMesh.add(soundCone);
    }

    function updateTweeterTransform() {
        tweeterRoot.position.set(state.pos.x, state.pos.y, state.pos.z);
        tweeterMesh.rotation.order = 'YXZ'; 
        tweeterMesh.rotation.y = THREE.MathUtils.degToRad(state.pan);
        tweeterMesh.rotation.x = THREE.MathUtils.degToRad(-state.tilt);
        
        const r = state.distance * Math.tan(THREE.MathUtils.degToRad(state.angle/2));
        soundCone.scale.set(r, r, state.distance);
        localRayDirs = generateFibonacciPoints(CONFIG.rayCount, state.angle);
        updateSimulation();
    }

    function initVisuals() {
        const maxP = CONFIG.rayCount * 2; 
        const pGeo = new THREE.BufferGeometry();
        pGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(maxP*3), 3));
        pGeo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(maxP*3), 3));
        heatmapSystem = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 0.02, map: createGlowTexture(), vertexColors: true, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending, depthWrite: false }));
        heatmapSystem.frustumCulled = false; scene.add(heatmapSystem);

        const lGeo = new THREE.BufferGeometry();
        lGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(maxP*6), 3)); 
        lGeo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(maxP*6), 3));
        laserLines = new THREE.LineSegments(lGeo, new THREE.LineBasicMaterial({ vertexColors: true, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.3 }));
        laserLines.frustumCulled = false; scene.add(laserLines);
    }

    function setupUIEvents() {
        const bind = (id, key, suffix='Â°') => {
            const el = document.getElementById(id);
            if(!el) return;
            const valEl = document.getElementById(id.replace('slider', 'val'));
            if(valEl) valEl.innerText = state[key] + suffix;
            el.oninput = function() {
                state[key] = parseFloat(this.value);
                if(valEl) valEl.innerText = this.value + suffix;
                updateTweeterTransform();
            };
        };
        bind('pan-slider', 'pan');
        bind('tilt-slider', 'tilt');
        
        // Disp-slider is hidden but we bind it anyway for safety
        bind('disp-slider', 'angle'); 

        ['x','y','z'].forEach(axis => {
            const el = document.getElementById(`pos-${axis}-slider`);
            el.oninput = function() {
                state.pos[axis] = parseFloat(this.value);
                updateTweeterTransform();
            };
        });
    }

    function onResize() {
        const container = document.getElementById('three-wrapper');
        if(!container || container.clientWidth === 0) return;
        
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
        updateSimulation();
    }

    function getRayPointDist(rayOrigin, rayDir, point) {
        const v = new THREE.Vector3().subVectors(point, rayOrigin);
        const t = v.dot(rayDir); 
        if (t < 0) return { dist: Infinity, point: rayOrigin.clone(), t: t }; 
        const closestPoint = rayOrigin.clone().add(rayDir.clone().multiplyScalar(t));
        return { dist: closestPoint.distanceTo(point), point: closestPoint, t: t };
    }

    function updateSimulation() {
        if(!environmentObjects.length) return;

        tweeterMesh.updateMatrixWorld();
        const origin = new THREE.Vector3(); tweeterMesh.getWorldPosition(origin);
        const quat = tweeterMesh.getWorldQuaternion(new THREE.Quaternion());
        
        let listenerPos = new THREE.Vector3();
        if(listenerZone) listenerZone.getWorldPosition(listenerPos);
        else listenerPos.copy(CONFIG.listenerCoords); 

        let directDist = origin.distanceTo(listenerPos);
        let theoreticalDirectSpl = 1.0 / (directDist * directDist);
        
        raycaster.set(origin, listenerPos.clone().sub(origin).normalize());
        raycaster.far = directDist - 0.05; 
        const occHits = raycaster.intersectObjects(environmentObjects, false);
        directSoundOccluded = (occHits.length > 0);

        const halfAngleRad = THREE.MathUtils.degToRad(state.angle / 2);
        let dispersionExp = 1;
        const cosHalf = Math.cos(halfAngleRad);
        if(cosHalf > 0 && cosHalf < 0.999) dispersionExp = Math.log(0.5) / Math.log(cosHalf);
        dispersionExp = THREE.MathUtils.clamp(dispersionExp, 0.5, 50);

        const posArr = heatmapSystem.geometry.attributes.position.array;
        const colArr = heatmapSystem.geometry.attributes.color.array;
        const linePos = laserLines.geometry.attributes.position.array;
        const lineCol = laserLines.geometry.attributes.color.array;
        const colLine = new THREE.Color(0x00aaff); 

        let hitCount = 0;
        let maxRiskRatio = 0;
        let worstPathDiff = 0;

        for(let i=0; i<localRayDirs.length; i++) {
            const localDir = localRayDirs[i];
            if(localDir.z <= 0) continue; 

            const dir = localDir.clone().applyQuaternion(quat).normalize();
            const offAxisFactor = Math.pow(localDir.z, dispersionExp); 
            if(offAxisFactor < 0.01) continue; 

            raycaster.set(origin, dir);
            raycaster.far = 3.5; 
            const hits = raycaster.intersectObjects(environmentObjects, false);
            
            if(hits.length > 0) {
                const hit = hits[0];
                const hitPt = hit.point;
                const d1 = hit.distance;
                const reflectivity = hit.object.userData.acoustics ? hit.object.userData.acoustics.reflectivity : 0.5;

                const I = dir.clone();
                let N = hit.face.normal.clone().applyQuaternion(hit.object.getWorldQuaternion(new THREE.Quaternion())).normalize();
                if (I.dot(N) > 0) N.negate(); 
                const R = I.clone().sub(N.clone().multiplyScalar(2 * I.dot(N))).normalize();

                const calc = getRayPointDist(hitPt, R, listenerPos);
                
                if (calc.dist < CONFIG.listenerRadius && calc.t > 0) {
                    const d2 = calc.t; 
                    const totalDist = d1 + d2;
                    const weight = Math.cos(calc.dist / CONFIG.listenerRadius * Math.PI / 2); 
                    
                    const reflectedSpl = (1.0 / (totalDist * totalDist)) * offAxisFactor * reflectivity * weight;
                    const ratio = reflectedSpl / theoreticalDirectSpl;

                    if (ratio > maxRiskRatio) {
                        maxRiskRatio = ratio;
                        worstPathDiff = totalDist - directDist;
                    }

                    if (ratio > 0.05) {
                        posArr[hitCount*3] = hitPt.x; posArr[hitCount*3+1] = hitPt.y; posArr[hitCount*3+2] = hitPt.z;
                        const dotColor = getSeverityColor(ratio);
                        colArr[hitCount*3] = dotColor.r; colArr[hitCount*3+1] = dotColor.g; colArr[hitCount*3+2] = dotColor.b;
                        linePos[hitCount*6] = origin.x; linePos[hitCount*6+1] = origin.y; linePos[hitCount*6+2] = origin.z;
                        linePos[hitCount*6+3] = hitPt.x; linePos[hitCount*6+4] = hitPt.y; linePos[hitCount*6+5] = hitPt.z;
                        lineCol[hitCount*6] = colLine.r; lineCol[hitCount*6+1] = colLine.g; lineCol[hitCount*6+2] = colLine.b;
                        lineCol[hitCount*6+3] = colLine.r; lineCol[hitCount*6+4] = colLine.g; lineCol[hitCount*6+5] = colLine.b;
                        hitCount++;
                    }
                }
            }
        }

        if(listenerZone) {
            const targetColor = getSeverityColor(maxRiskRatio);
            listenerZone.material.color.lerp(targetColor, 0.1);
            listenerZone.material.opacity = THREE.MathUtils.lerp(listenerZone.material.opacity, 0.2 + maxRiskRatio * 1.5, 0.1);
        }

        for(let k=hitCount*3; k<posArr.length; k++) posArr[k] = 0;
        for(let k=hitCount*6; k<linePos.length; k++) linePos[k] = 0;
        heatmapSystem.geometry.setDrawRange(0, hitCount);
        heatmapSystem.geometry.attributes.position.needsUpdate = true;
        heatmapSystem.geometry.attributes.color.needsUpdate = true;
        laserLines.geometry.setDrawRange(0, hitCount * 2);
        laserLines.geometry.attributes.position.needsUpdate = true;
        laserLines.geometry.attributes.color.needsUpdate = true;

        updateDashboard(maxRiskRatio, worstPathDiff);
    }

    function updateDashboard(maxRatio, pathDiff) {
        const elLetter = document.getElementById('grade-letter');
        const elDesc = document.getElementById('grade-desc');
        const barDirect = document.getElementById('bar-direct');
        const valDirect = document.getElementById('val-direct');
        const barRefl = document.getElementById('bar-refl');
        const valRefl = document.getElementById('val-refl');
        const valFreq = document.getElementById('val-freq');
        const elAdvice = document.getElementById('advice-text');

        if (directSoundOccluded) {
            barDirect.style.width = "40%"; barDirect.className = "metric-bar-fill bg-c"; 
            valDirect.innerText = "BLOCK"; valDirect.className = "metric-val color-c";
        } else {
            barDirect.style.width = "100%"; barDirect.className = "metric-bar-fill bg-a"; 
            valDirect.innerText = "OK"; valDirect.className = "metric-val color-a";
        }

        const p = Math.min(maxRatio * 100, 100).toFixed(1);
        valRefl.innerText = p + "%";
        barRefl.style.width = Math.min(maxRatio * 300, 100) + "%"; 
        
        let freqStr = "--";
        if (maxRatio > 0.05 && pathDiff > 0) {
            const f = 343 / (2 * pathDiff);
            freqStr = (f > 20000) ? ">20k" : Math.round(f) + " Hz";
        }
        valFreq.innerText = freqStr;

        let grade = 'A'; let desc = 'GOOD'; let gClass = 'color-a'; let advice = "";
        if (maxRatio <= 0.08) {
            grade = 'S'; desc = 'REFERENCE'; gClass = 'color-s'; barRefl.className = "metric-bar-fill bg-s"; advice = "âœ… å®Œç¾å£°åœºï¼šåå°„èƒ½é‡æä½ï¼Œç»“åƒæ¸…æ™°ã€‚";
        } else if (maxRatio <= 0.18) {
            grade = 'A'; desc = 'EXCELLENT'; gClass = 'color-a'; barRefl.className = "metric-bar-fill bg-a"; advice = "âœ¨ ä¼˜ç§€è¡¨ç°ï¼šåå°„æ§åˆ¶å¾—å½“ã€‚";
        } else if (maxRatio <= 0.30) {
            grade = 'B'; desc = 'STANDARD'; gClass = 'color-b'; barRefl.className = "metric-bar-fill bg-b"; advice = "ğŸ†— è¡Œä¸šæ ‡å‡†ï¼šå­˜åœ¨å¸¸è§„åå°„ã€‚å»ºè®®å¾®è°ƒè§’åº¦ã€‚";
        } else {
            grade = 'C'; desc = 'RISK'; gClass = 'color-d'; barRefl.className = "metric-bar-fill bg-d"; advice = `âš ï¸ åå°„è¿‡å¼ºï¼š${freqStr} å¤„å¯èƒ½æœ‰ä¸¥é‡å¹²æ¶‰ã€‚`;
        }
        if (directSoundOccluded && grade !== 'C') advice = "âš ï¸ æ³¨æ„ï¼šç›´è¾¾å£°è¢«é®æŒ¡ã€‚";

        elLetter.innerText = grade; elLetter.className = `grade-value ${gClass}`;
        elDesc.innerText = desc; elDesc.className = `grade-desc bg-${gClass.replace('color-', '')}`; elDesc.style.color = '#000';
        elAdvice.innerText = advice;
    }

    function animate() {
        requestAnimationFrame(animate);
        orbit.update();
        renderer.render(scene, camera);
    }
    
    // Start Simulation
    init();
</script>
</body>
</html>